
/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for a KPI dashboard application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an Admin by checking the 'role' custom claim.
     */
    function isAdmin() {
      // This function relies on a custom claim set by a backend process.
      // The claim is NOT automatically set when a user's role is stored in their /users/ document.
      return isSignedIn() && request.auth.token.role == 'Admin';
    }
    
    /**
     * @description Checks if the user has a managerial role via custom claims.
     */
    function isManager() {
       return isSignedIn() && request.auth.token.role in ['Admin', 'VP', 'AVP', 'Manager'];
    }
    
    /**
     * @description Checks if the user is a direct manager of a given employee.
     */
    function isDirectManagerOf(employeeId) {
        return exists(/databases/$(database)/documents/employees/$(employeeId)) &&
               get(/databases/$(database)/documents/employees/$(employeeId)).data.managerId == request.auth.uid;
    }

    /**
     * User Profiles: Storing user roles and app-specific data.
     * - Users can read/write their own profile.
     * - Admins can read/write any user's profile for management.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
    }

    /**
     * Employees Master Data: Core HR information.
     * - All authenticated users can read employee data (e.g., to see names, departments).
     * - Only Admins can modify employee records.
     */
    match /employees/{employeeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Departments, Positions, Roles: Core configuration data.
     * - Readable by all authenticated users to populate UI selectors and understand structure.
     * - Writable only by Admins.
     */
    match /departments/{departmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /positions/{positionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * KPI Catalog: The master list of all corporate KPIs.
     * - Readable by all signed-in users.
     * - Writable only by admins.
     */
    match /kpi_catalog/{kpiId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Cascaded KPIs: Department-level versions of corporate KPIs.
     * - Readable by all signed-in users.
     * - Writable by managers and admins.
     */
    match /cascaded_kpis/{cascadedKpiId} {
      allow read: if isSignedIn();
      allow write: if isManager();
    }

    /**
     * Individual KPIs: KPIs assigned to specific employees.
     * - A user can read any KPI (to see cascaded goals).
     * - A user can only write to their own KPIs, or managers can write to their reports' KPIs.
     */
    match /individual_kpis/{individualKpiId} {
        allow read: if isSignedIn();
        allow write: if isManager() || isOwner(resource.data.employeeId);
    }

    /**
     * KPI Submissions: Data submitted by employees against their KPIs.
     * - Users can create submissions.
     * - Only the submitter, their manager, or an admin can view/update/delete a specific submission.
     * - LISTING is explicitly disallowed to force targeted queries and prevent data leakage.
     */
    match /kpi_submissions/{submissionId} {
        allow get, update, delete: if isAdmin() || isOwner(resource.data.submittedBy) || isDirectManagerOf(resource.data.submittedBy);
        allow create: if isSignedIn();
        allow list: if false; 
    }

    /**
     * Monthly KPIs: Monthly breakdown of corporate KPIs for tracking.
     * - Readable by all signed-in users.
     * - Writable only by admins.
     */
    match /monthly_kpis/{monthlyKpiId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Global Settings: System-wide configuration.
     * - Readable by any authenticated user.
     * - Writable only by Admins.
     */
    match /settings/global {
      allow get: if isSignedIn();
      allow list, write: if isAdmin();
    }
  }
}

    