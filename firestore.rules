/**
 * @fileoverview Firestore Security Rules for the KPI Dashboard application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles and ownership.
 * It leverages Firebase Authentication to verify user identity and enforces
 * granular permissions for reading and writing data.  Data validation is minimized to
 * allow for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible to the user and admins.
 * - /employees/{employeeId}: Stores employee data, readable by all authenticated users, writable by admins.
 * - /departments/{departmentId}: Stores department data, readable by all authenticated users, writable by admins.
 * - /kpi_categories/{kpiCategoryId}: Stores KPI categories, readable by all authenticated users, writable by admins.
 * - /kpi_catalog/{kpiId}: Stores the master KPI list, readable by all authenticated users, writable by admins.
 * - /cascaded_kpis/{cascadedKpiId}: Stores KPIs cascaded to departments, readable by all, writable by managers/admins.
 * - /individual_kpis/{individualKpiId}: Stores KPIs assigned to individual employees, read/write access controlled by role and ownership.
 * - /kpi_submissions/{kpiSubmissionId}: Stores KPI submissions, accessible to the submitter and their manager.
 * - /kpi_approvals/{kpiApprovalId}: Stores KPI approvals, accessible to involved parties.
 * - /reports/{reportId}: Stores performance reports, access control to be determined.
 * - /settings/global: Stores global application settings, readable by all, writable by admins.
 * - /monthly_kpis/{monthlyKpiId}: Stores monthly KPI breakdowns, readable by all, writable by admins.
 *
 * Key Security Decisions:
 * - User listing is restricted to admins only.
 * - All write operations require authentication.
 * - Data validation is minimized in favor of rapid prototyping.  Focus is on authorization.
 *
 * Role-Based Access Control:
 * - Admins have full read/write access to most collections.
 * - Managers can write to cascaded and individual KPIs.
 * - Employees can update the status of their individual KPIs.
 *
 * Denormalization for Authorization:
 *  - The `MonthlyKpi` entity contains a `createdBy` field to track the user who deployed it.  This field is used for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profiles based on ownership.
     * @path /users/{userId}
     * @allow (get, update, delete): Authenticated user with matching userId.
     * @allow (create): Authenticated user creating their own profile.
     * @deny (get, list): Non-authenticated user.
     * @deny (create, update, delete): Authenticated user attempting to modify another user's profile.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get, update, delete: if isOwner(userId);
      allow create: if request.auth.uid == userId;
      allow list: if false;
    }

    /**
     * @description Allows read access to employee data for all authenticated users. Write access is restricted to admins.
     * @path /employees/{employeeId}
     * @allow get, list: All authenticated users.
     * @allow create, update, delete: Admins only.
     * @deny create, update, delete: Non-admin users.
     * @principle Provides public read access to employee data while restricting write access to admins.
     */
    match /employees/{employeeId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows read access to department data for all authenticated users. Write access is restricted to admins.
     * @path /departments/{departmentId}
     * @allow get, list: All authenticated users.
     * @allow create, update, delete: Admins only.
     * @deny create, update, delete: Non-admin users.
     * @principle Provides public read access to department data while restricting write access to admins.
     */
    match /departments/{departmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows read access to KPI category data for all authenticated users. Write access is restricted to admins.
     * @path /kpi_categories/{kpiCategoryId}
     * @allow get, list: All authenticated users.
     * @allow create, update, delete: Admins only.
     * @deny create, update, delete: Non-admin users.
     * @principle Provides public read access to KPI category data while restricting write access to admins.
     */
    match /kpi_categories/{kpiCategoryId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows read access to KPI catalog data for all authenticated users. Write access is restricted to admins.
     * @path /kpi_catalog/{kpiId}
     * @allow get, list: All authenticated users.
     * @allow create, update, delete: Admins only.
     * @deny create, update, delete: Non-admin users.
     * @principle Provides public read access to KPI catalog data while restricting write access to admins.
     */
    match /kpi_catalog/{kpiId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

     /**
      * @description Allows read access to cascaded KPI data for all authenticated users. Write access is restricted to managers and admins.
      * @path /cascaded_kpis/{cascadedKpiId}
      * @allow get, list: All authenticated users.
      * @allow create, update, delete: Managers and admins only.
      * @deny create, update, delete: Non-manager/admin users.
      * @principle Provides public read access to cascaded KPI data while restricting write access to managers and admins.
      */
    match /cascaded_kpis/{cascadedKpiId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isManager() || isAdmin();
    }

    /**
     * @description Allows access to individual KPI data based on role and ownership.
     * @path /individual_kpis/{individualKpiId}
     */
    match /individual_kpis/{individualKpiId} {
      allow get, list: if isSignedIn(); // Placeholder: Refine with manager access
      allow create, update, delete: if isManager() || isAdmin(); // Placeholder: refine with employee self-update for specific fields.
    }

    /**
     * @description Allows access to KPI submission data based on ownership.
     * @path /kpi_submissions/{kpiSubmissionId}
     */
    match /kpi_submissions/{kpiSubmissionId} {
      allow get, list: if isSignedIn(); // Placeholder: Refine with manager access
      allow create: if isSignedIn();
      allow update, delete: if isSubmitter(getAfter(request).submittedByUserId) || isManager() || isAdmin();
    }

    /**
     * @description Allows access to KPI approval data.
     * @path /kpi_approvals/{kpiApprovalId}
     */
    match /kpi_approvals/{kpiApprovalId} {
      allow get, list: if isSignedIn(); // Placeholder: Add granular access control
      allow create, update, delete: if isAdmin(); // Placeholder: Add approval logic
    }

    /**
     * @description Allows access to report data.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      allow get, list: if isSignedIn(); // Placeholder: Add granular access control
      allow create, update, delete: if isAdmin(); // Placeholder: Add report creation logic
    }

    /**
     * @description Allows read access to global settings for all authenticated users. Write access is restricted to admins.
     * @path /settings/global
     */
    match /settings/global {
      allow get: if isSignedIn();
      allow create, update, delete: if isAdmin();
      allow list: if false;
    }

    /**
     * @description Allows read access to monthly KPI data for all authenticated users. Write access is restricted to admins.
     * @path /monthly_kpis/{monthlyKpiId}
     * @allow get, list: All authenticated users.
     * @allow create, update, delete: Admins only.
     * @deny create, update, delete: Non-admin users.
     * @principle Provides public read access to monthly KPI data while restricting write access to admins.
     */
    match /monthly_kpis/{monthlyKpiId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // ---- Helper Functions ----

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth.token.role == 'Admin';
    }

    function isManager() {
      return request.auth.token.role == 'Manager';
    }

    function isSubmitter(submittedByUserId) {
        return request.auth.uid == submittedByUserId;
    }

    function getAfter(request) {
        return request.resource.data;
    }
  }
}