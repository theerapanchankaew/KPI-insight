
/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for a KPI dashboard application.
 *
 * Key Security Decisions:
 * - Admins are granted universal read/write access to all data for management purposes.
 * - Non-admin access is defined on a per-collection basis, generally allowing reads for most data but restricting writes.
 * - User-specific data (like individual KPIs) has rules to ensure users can only access their own information or information of their direct reports.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId - The user ID to compare against.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an Admin by checking for 'admin' in their roles token.
     */
    function isAdmin() {
      return isSignedIn() && 'admin' in request.auth.token.roles;
    }
    
    /**
     * @description Checks if the user is a manager or above.
     */
    function isManager() {
      return isSignedIn() && (
        'admin' in request.auth.token.roles ||
        'vp' in request.auth.token.roles ||
        'avp' in request.auth.token.roles ||
        'manager' in request.auth.token.roles
      );
    }
    
    /**
     * @description Checks if the user is a direct manager of a given employee.
     */
    function isDirectManagerOf(employeeId) {
        let employeeDoc = get(/databases/$(database)/documents/employees/$(employeeId)).data;
        return employeeDoc.managerId == request.auth.uid;
    }
    

    /**
     * User Profiles: Only the user or an admin can read/write their own profile.
     * Admins can list all users.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
    }

    /**
     * Employees Master Data: Readable by all signed-in users.
     * Writable only by Admins.
     */
    match /employees/{employeeId} {
      allow get, list: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Departments, Positions, Roles: Configuration data readable by all, writable by admins.
     */
    match /departments/{departmentId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
    }
    
    match /positions/{positionId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
    }
    
    match /roles/{roleId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
    }

    /**
     * KPI Catalog: The master list of all corporate KPIs.
     * Readable by all, writable only by admins.
     */
    match /kpi_catalog/{kpiId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
    }

    /**
     * Cascaded KPIs: KPIs that have been cascaded to departments.
     * Readable by all, writable by managers/admins.
     */
    match /cascaded_kpis/{cascadedKpiId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
      allow write: if isManager();
    }

    /**
     * Individual KPIs: Assigned to employees.
     * - Readable by the user, their manager, or an admin.
     * - Writable by the user (for status changes) or their manager/admin.
     */
    match /individual_kpis/{individualKpiId} {
        allow read, write: if isAdmin();
        allow get, list: if isSignedIn() && (isOwner(resource.data.employeeId) || isDirectManagerOf(resource.data.employeeId));
        allow create: if isManager();
        
        // Allow employee to submit for review or acknowledge
        allow update: if isOwner(resource.data.employeeId) && 
                        (request.resource.data.status == 'Manager Review' || request.resource.data.status == 'In-Progress');
                        
        // Allow manager to update or reject
        allow update: if isDirectManagerOf(resource.data.employeeId) || isManager();
        
        allow delete: if isManager();
    }

    /**
     * KPI Submissions: Data submitted by employees.
     * - Readable by the submitter, their manager, or an admin.
     * - Writable only by the submitter.
     */
    match /kpi_submissions/{submissionId} {
        allow read, write: if isAdmin();
        allow create: if isSignedIn();
        allow get, list: if isSignedIn() && (isOwner(resource.data.submittedBy) || isDirectManagerOf(resource.data.submittedBy));
    }

    /**
     * Monthly KPIs: Monthly breakdown of corporate KPIs.
     * Readable by all, writable by admins.
     */
    match /monthly_kpis/{monthlyKpiId} {
      allow read, write: if isAdmin();
      allow get, list: if isSignedIn();
    }

    /**
     * Global Settings: Readable by all, writable only by admins.
     */
    match /settings/global {
      allow read, write: if isAdmin();
      allow get: if isSignedIn();
    }
  }
}
